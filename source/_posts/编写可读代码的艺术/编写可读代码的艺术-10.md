---
title: 组织代码简单的技巧
tags:
  - 职业修养
categories:
  - 读书笔记
  - 编写可读代码的艺术
date: 2020-01-24 15:24:48
visible:
---


# 一次只做一件事

代码的易读程度和它同时处理的事务数量成反比，如果一个代码块将初始化对象，清除数据，解析输入，然后应用业务逻辑这些流程都同时进行。对于每个“任务”都很难靠其自身来帮你理解它从哪里开始，到哪里结束。

这里面的思想是每个代码块之间应该最大限度的相互独立，只完成一个功能就好，耦合性不可太高。

应该把代码组织的一次只做一件事。就像是一个函数应该只实现一个功能（拆分为小的函数或者在函数中分为一个个独立的逻辑段落），让代码看起来逻辑和逻辑之间是分开的。

具体实现流程如下：

1. 列出代码所做的所有“任务”。这里的“任务”没有很严格的定义——它可以小得如“确保这个对象有效”，或者含糊得如“遍历树中所有结点”。

2. 尽量把这件任务拆分到不同的函数中，或者至少是代码中不同的段落中。

## 任务可以很小

例如使用`JavaScript`做一个用来投票的逻辑，用户可以给一条评论投“上”或“下”票。每条评论的总分为所有投票的和：“上”票对应分数为`+1`，“下”票`-1`。

![](00132.jpg)

这个函数看似只实现了一个功能，但是内部是做了两件事情。

1. 根据点击的按钮判断数值
2. 更新投票数

业务逻辑为用户可以多次投票，但是每个按钮只能点击一次。如果第一次投了“下”票，第二次只能取消（+1）或者“上”（+2），反之也如此。

这段代码理解起来很麻烦，主要是因为业务逻辑写了太多（if 语句）。将任务分开解决的代码如下：

```JavaScript
var vote_value = function(vote) {
    if(vote === "up"){
        return +1;
    }
    if(vote === "down") {
        return -1;
    }
    return 0;
}
```

将每次判断值的功能封装起来。整个函数修改之后就是这样：

![](00138.jpg)

新的代码逻辑只需要看一次就能很快的理解。如果有`bug`，也可以很快定位。

## 从对象中抽取值

有一个需求，要将用户的位置格式化成“城市，国家”这样的格式化字符串。有一个对应的字典，里面存放着结构化的信息。

![](00140.jpg)

前三项是`City`的选项，最后一项是`Country`的选项。当选择`City`时，按照从上到下的顺序依次取值。如果第一个没有，就选第二个，全都没有就给一个默认值`Middle-of-Nowhere`。当然，如果`Country`没有值就使用`Planet Earth`。

下面这段代码可以实现这个需求：

![](00142.jpg)

显而易见，这段代码有一个致命的问题。如果以后要改一个小需求，例如修改某一部分的值显示为字典中其他的字段。这需要查看整个代码块来看新功能需要修改哪里。

### 应用“一次只做一件事情”原则

上一小节的代码已经在同时完成多项任务了：

1. 从字典`location_info`中提取值。

2. 按喜好顺序找到`City`，如果找不到就给默认值`Middle-of-Nowhere`。

3. 找到`Country`，如果找不到的话就用`Planet Earth`。

4. 更新`place`。

可以根据任务内容一步一步的分开来独立解决。

首先将需要的字段提取出来：

![](00143.jpg)

之后按照最终需要的字符串格式来分开实现：

![](00145.jpg)

![](00147.jpg)

最后只需要将这两个字符串拼接一下就可以了。

### 另一种做法

早先的一连串`if`语句需要小心地去读才能知道每种情况是否都对。在那段代码中其实有两个子任务同时在进行：

1. 遍历一系列变量，找出可用变量中最满意的那一个。

2. 依据`Country`是否存在而采用不同的值。

根据需求可知，`Country`只有两种可能，一种是字典中存在该字段（有且只有一个），一种是字典中不存在，使用替代值。

可以从`Country`入手，将代码分为两段：

![](00153.jpg)

`JavaScript`的逻辑或运算符（`||`）总是会返回第一个为`true`的值。这样写代码大量的`if`语句都被优化掉了，可读性会更好，关于业务逻辑的繁琐代码也变短了。

## 更大型的例子

有一个网页爬虫系统，会在下载每个网页后调用`UpdateCounts()`的函数来增加不同的统计数据。

![](00155.jpg)

理想的情况下是这样的，但是实际上`HttpDownload`是下面这样：

![](00158.jpg)

代码中交织的任务为：

1. 使用`unknown`作为每个键的默认值。
2. 检测`HttpDownload`的成员是否缺失。
3. 抽取出值并将其转换成字符串。
4. 更新`counts[]`。

通过给代码中的任务分组来改进代码：

![](00161.jpg)

代码分为三个区域：

1. 为我们感兴趣的三个键定义默认值。

2. 对于每个键，如果有的话就抽取出值，然后把它们转换成字符串。

3. 对于每个键/值更新`counts[]`。

这三个区域是完全独立的，在看一块代码的时候，完全不必因为关联其他部分的代码而跳跃。

当然也可以将这三个区域中属于一个部分的操作抽成一个函数，这样只需要三个函数就可以实现对应的功能（段首理想情况的形式）。

## 总结

本章给出了一个组织代码的简单技巧：一次只做一件事情。

如果你有很难读的代码，尝试把它所做的所有任务列出来。其中一些任务可以很容易地变成单独的函数（或类）。其他的可以简单地成为一个函数中的逻辑“段落”。具体如何拆分这些任务没有它们已经分开这个事实那样重要。难的是要准确地描述你的程序所做的所有这些小事情。
