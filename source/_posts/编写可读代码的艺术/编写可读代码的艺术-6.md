---
title: 如何精简代码控制流
tags:
  - 职业修养
categories:
  - 读书笔记
  - 编写可读代码的艺术
date: 2020-01-11 11:30:42
---

# 第七章：把控制流变得易读

所有代码的基础就是条件判断，循环或任何其他的控制流语句，代码中最难读的也就是跳转和分支。本章的目的就是教会读者如何**把条件、循环以及其他对控制流的改变做得越“自然”越好。运用一种方式使读者不用停下来重读你的代码**。

## 条件语句中参数的顺序

对比这两段代码：

```JavaScript
if(length >= 10)
while(bytes_received < bytes_expected)
```

```JavaScript
if(10 <= length)
while(bytes_expected > bytes_received)
```

很明显第一段更加易读，两段代码的区别在于前者比较的左侧更倾向于不断变化，比较的右侧的值总是更倾向于是一个常量。

和语言是相同的，“如果你的年龄不大于 18 岁”比“如果 18 岁不大于你的年龄”的说法更常见，当然也不排除有的人会说第二种。

尤达表示法则是背道而驰的，起源在于某些语言在判断语句中可以给变量赋值：

```C
if(obj = NULL)
```

这行代码本来的意思可能是`obj == NULL`，为了避免这个`bug`，大多数人会将参数调换成`NULL == obj`，这样如果误写的话，编译的时候就会报错。

现代编译器已经将这种写法列为警告，可见这种写法已经过时了。

> “Yoda 表示法”的名字来源于《星球大战》的 Yoda 大师。 他说话的单词顺序相当奇特，比如：“Backwardsitis,yes!” 一般认为使用这个表示法是为了“变通”（workaround）C/C++的一个设计抉择：使用=来表示赋值，而使用==来表示比较。

## if/else 语句块的顺序

在写条件判断语句的时候，在语法上（`if`和`else`）顺序是可以随意转换的。关于如何编写逻辑的顺序有一套通用的方法，可以用来参考：

- 首先处理正逻辑而不是负逻辑的情况。例如，用`if(debug)`而不是`if(!debug)`。

- 先处理掉简单的情况。这种方式可能还会使得`if`和`else`在屏幕之内都可见，这很好。

- 先处理有趣的或者是可疑的情况。

有时这些倾向性之间会有冲突，那么你就要自己判断了。但在很多情况下这都会有明确的选择。排除掉在自己看起来`if/else`顺序很别扭的情况就可以了。

## 条件表达式（三元运算符）

三元运算符可以让代码更加紧凑，如果使用得当，易读性也会增强。

有些三元运算符可以一行完成的功能换成使用`if/else`至少要五行。尤其是进行简单的条件判断从而选择不同的值的时候，三元运算符很有用。

```javascript
a = b ? 1 : 2;
```

这就是一个使用三元运算符的例子。然而，为了缩短代码行数来强行使用三元运算符是不可取的。依稀记得在前公司写`React`的时候，条件渲染是这样的：

```javascript
a ? b  : c ? d : e ...
```

`render`方法中大量的语句都是使用三元运算符加逻辑运算符进行条件渲染，还没有封装成对象，毫无扩展性。可见我维护这种代码时候的心情。

相对于追求最小化代码行数，一个好的度量方法就是最小化人们理解它所需要的时间，使用`if/else`可以使代码更加自然。书中给出的建议是默认情况下都使用`if/else`，只有在特别简单的情况下才使用三元运算符。

## 避免 do/while 循环

![](Jietu20200111-161943.jpg)

与其他的控制流语句不同，该循环中的表达式必定会被执行一次，一个代码块是否会执行是由其后的一个条件决定的。通常来讲，逻辑条件应该出现在它们所“保护”的代码之前，这也是`if`、`while`和`for`语句的工作方式。因为你通常会从前向后来读代码，这就使得`do/while`循环有点不自然了。很多读者最后会读这段代码两遍。

`do/while`语句大多数情况下都可以改写为`while`和`if + for`的形式。但是在编程语言中，发展了这么多年，肯定有它们不可被替代的部分。`do/while`语言最有用的地方可能就是在宏编程中使用了。

```C
do {
    // xxx
    // 如果是continue; 循环只执行一次
} while(0)
```

这种情况下`do`能确保大括号里的逻辑能被执行，而`while(0)`能确保该逻辑只被执行一次，即与没有循环时一样。

除非必须使用`do/while`语句，其余情况尽量避免使用该语句，会增加代码的阅读难度。

## 从函数中提前返回

函数中是可以出现多条`return`语句的，从函数中提前返回没有任何问题。这种提前`return`的语句被称为保护语句（guard clause）。可以让更短，更简单，缩进的深度也更少。

![](00222.jpg)

想要单一出口点的一个动机是保证调用函数结尾的清理代码。但现代的编程语言为这种保证提供了更精细的方式：

![](00223.jpg)

> A guard clause is simply a check that immediately exits the function, either with a return statement or an exception. If you’re used to writing functions that check to ensure everything is valid for the function to run, then you write the main function code, and then you write else statements to deal with error cases, this involves inverting your current workflow. The benefit is that your code will tend to be shorter and simpler, and less deeply indented.

## 臭名昭著的 goto

对于 C 语言我不是很熟悉，只在大一上课的时候学过。不过思想是相通的，从本节末的`goto`说明就可以看出，如果这些路径交叉，可能会产生面条式代码，代码肯定会变得及其难以阅读，观看来回跳跃的代码就是一场灾难。

```C
goto label;
..
.
label: statement;
```

> C 语言中的 goto 语句允许把控制无条件转移到同一函数内的被标记的语句。
> 注意：在任何编程语言中，都不建议使用 goto 语句。因为它使得程序的控制流难以跟踪，使程序难以理解和难以修改。任何使用 goto 语句的程序可以改写成不需要使用 goto 语句的写法。

> 面条式代码（Spaghetti code）是软件工程中反面模式的一种，是指一个源代码的控制流程复杂、混乱而难以理解，尤其是用了很多 GOTO、例外、线程、或其他无组织的分支。 其命名的原因是因为程式的流向就像一盘面一样的扭曲纠结。 面条式代码的产生有许多原因，例如没有经验的程序设计师，及已经过长期频繁修改的复杂程序。

## 最小化嵌套

嵌套很深的代码难以理解，虽然每次嵌套只是增加了一个条件，日积月累，就会变成维护人员的灾难。

```javascript
if() {
    if() {
        ...
    }
} else if(){
    if(){
        ...
    }
}else {
    ...
}
```

当遇到这种深层嵌套的代码，如果判定条件稍显复杂再加上同一个判定条件的来回切换，对读者的理解都会造成很大的困难。

### 嵌套是如何累积的

要解决问题，首先要知道问题是怎样产生的。这种情况产生的原因很简单，因为代码是一个团队在维护，随着需求的变化，今天你加一行，明天他加一行。代码就会变得越来越复杂。而且对于之前的每个人来说，代码的上下文都在，理解起来很清晰。直到某个倒霉蛋最后接盘，上下文已经不在，只能硬着头皮修改。

### 如何解决嵌套

- 当对代码做改动的时候，从全新的角度审视它，把它作为一个整体来看待
- 通过提早返回来改进代码，给每个`if`语句一个返回值，这样就只有一层嵌套，读者理解起来也会很容易
- 提前返回不是万能的，如果在循环中有嵌套，就应该使用`continue`等语句操作

### 循环中的提前返回

循环中的提前返回指的是提前终止循环。向`return`语句一样，但不同的是该操作是以循环为单位，影响的只是一个循环。

下面是相关语句的区别：

- break：直接跳出循环且最后一个循环值不执行
- continue：跳出循环啊并进入下一个循环
- return： 跳出循环返回一个值

与`if(……)return;`在函数中所扮演的保护语句一样，这些`if(……)continue`语句是循环中的保护语句。

一般来讲，`continue`语句让人很困惑，因为它让读者不能连续地阅读，就像循环中有`goto`语句一样。但是在这种情况中，循环中的每个迭代是相互独立的（这是一种"`for each`"循环），因此读者可以很容易地领悟到这里`continue`的意思就是“跳过该项”

## 理解执行的流程

本章介绍低层次控制流：如何把循环、条件和其他跳转写得简单易读。但是也应该从高层次来考虑程序的“流动”。理想的情况是，整个程序的执行路径都很容易理解——从`main()`开始，然后在脑海中一步步执行代码，一个函数调用另一个函数，直到程序结束。

除此之外，编程语言还有很多幕后代码在一直运行：

![](00038.jpg)

这些会让代码变得更加简洁，冗余更少，更加有可读性。但是这些结构会让`bug`更加难找，关键是不要让代码中使用这些结构的比例太高。

## 总结

有几种方法可以让代码的控制流更易读。

- 在写一个比较时（`while(bytes_expected＞bytes_received)`），把改变的值写在左边并且把更稳定的值写在右边更好一些（while`(bytes_received＜bytes_expected)`）。

- 你也可以重新排列`if/else`语句中的语句块。通常来讲，先处理正确的/简单的/有趣的情况。有时这些准则会冲突，但是当不冲突时，这是要遵循的经验法则。

- 某些编程结构，像三目运算符（`:?`）、`do/while`循环，以及`goto`经常会导致代码的可读性变差。最好不要使用它们，因为总是有更整洁的代替方式。

- 嵌套的代码块需要更加集中精力去理解。每层新的嵌套都需要读者把更多的上下文“压入栈”。应该把它们改写成更加“线性”的代码来避免深嵌套。

- 通常来讲提早返回可以减少嵌套并让代码整洁。“保护语句”（在函数顶部处理简单的情况时）尤其有用。
