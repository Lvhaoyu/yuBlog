---
title: 与 HTTP 相关的 Web 服务器
tags:
  - web前端
  - 网络基础
categories:
  - 读书笔记
  - 图解HTTP
date: 2020-01-10 10:55:11
---

# 与 HTTP 协作的 Web 服务器

一台 Web 服务器可以用来搭建多个独立域名的 Web 网站，也可作为通信路径上的中转服务器提升传输效率。

## 用单台虚拟主机实现多个域名

> 虚拟主机（英语：virtual hosting）或称 共享主机（shared web hosting），又称虚拟服务器，是一种在单一主机或主机群上，实现多网域服务的方法，可以运行多个网站或服务的技术。虚拟主机之间完全独立，并可由用户自行管理，虚拟并非指不存在，而是指空间是由实体的服务器延伸而来，其硬件系统可以是基于服务器群，或者单个服务器。

由于`DNS`服务的存在，请求是以`IP`地址的方式来访问服务器，每个虚拟主机都有自己独一无二的`IP`地址，而且多个域名可以映射到相同的`IP`地址。所以在相同的`IP`地址下，虚拟主机可以寄存多个不同主机名和域名的 Web 网站，因此在发送 `HTTP`请求时，必须在`Host`首部内完整指定主机名或域名的`URI`。

## 通信数据转发程序：代理、网关、隧道

这三种转发程序是用于通信数据转发的，他们配合服务器和客户端的工作，不仅可以将请求转发给下一站服务器，还可以接收服务器的响应转发给客户端。如果将`HTTP`通信比作送快递的话，货物由发货地（客户端）发到收货地（服务器），中间要经过很多的中转，这三种应用程序就相当于快递的中转。

### 代理

代理又叫**拦截服务器**，是一种有转发功能的应用程序，它扮演了位于服务器和客户端“中间人”的角色，接收由客户端发送的请求并转发给服务器，同时也接收服务器返回的响应并转发给客户端。

代理不会改变请求的`URI`，将请求直接发送给前方的目标服务器，每次通过代理服务器转发请求或响应时，会追加写入`Via: proxy1, proxy2`首部字段（多个代理使用逗号分隔）来标记出经过的主机信息，使用代理，请求行中的`URI`必须使用绝对路径，然后代理可能会在进行改写之后发送给远端服务器。

![](1.png)

代理对于客户端而言就是服务器，对于服务器而言就是客户端。可以根据是否使用缓存和是否修改报文分为两类：

- 缓存代理
  - 代理转发响应时，缓存代理（Caching Proxy）会预先将资源的副本（缓存）保存在代理服务器上。当代理再次接收到对相同资源的请求时，就可以不从源服务器那里获取资源，而是将之前缓存的资源作为响应返回。
- 透明代理
  - 转发请求或响应时，不对报文做任何加工的代理类型被称为透明代理（Transparent Proxy）。反之，对报文内容进行加工的代理被称为非透明代理。

具体应用如下：

- 抓包，例如 Charles 等抓包工具就是使用代理来进行抓包
- FQ，原理和`VPN`完全不同，后者主要是使用隧道实现，而前者是使用 Web 代理来实现
- 匿名访问，代理可以删除原始用户请求报文的敏感信息，且不会记录历史
- 过滤器，`HTTP`无识别用户能力，使用代理服务器可以对请求进行分析和拦截

### 网关

网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，它就像自己拥有资源的源服务器一样对请求进行处理。有时客户端可能都不会察觉，自己的通信目标是一个网关。网关可以作为某种翻译器使用，抽象了一种可以到达资源的方法。网关是资源和应用程序之间的粘合剂。扮演的是“协议转换器”的角色。

> 在计算机网络中，网关（英语：Gateway）是转发其他服务器通信数据的服务器，接收从客户端发送来的请求时，它就像自己拥有资源的源服务器一样对请求进行处理。有时客户端可能都不会察觉，自己的通信目标是一个网关。
> 区别于路由器（由于历史的原因，许多有关 TCP/IP 的文献曾经把网络层使用的路由器（英语：Router）称为网关，在今天很多局域网采用都是路由来接入网络，因此现在通常指的网关就是路由器的 IP），经常在家庭中或者小型企业网络中使用，用于连接局域网和互联网。
> 网关也经常指把一种协议转成另一种协议的设备，比如语音网关。

![](2.png)

上图可见网关和代理看起来十分相似，最大的区别就是网关两侧的协议可以不同，在一侧使用`HTTP`协议，在另一侧使用另一种协议。网关可以分为以下两大类：

- （HTTP/）服务器端网关：通过`HTTP`协议和客户端对话，通过其他协议与服务器通信
- （/HTTP）客户端网关：通过其他协议与客户端对话，通过`HTTP`协议与服务器通信

具体应用如下：

- （HTTP/\*）服务器端 Web 网关
  - E-Mail
  - FTP
  - 数据库
- （HTTP/HTTPS）服务器端安全网关：从客户端发`HTTP`，网关进行加密
- （HTTPS/HTTP）客户端安全加速器网关，客户端发`HTTPS`，网关进行解密
  - 二者有专门的解密软件，效率高于服务器解密
- 资源网关：客户端发请求到服务器，服务器将请求的资源通过网关的`API`发送给服务器
  - 人脸识别系统
  - 网络摄像头
  - `HTTP` **-->** `RPC`

> RPC 是指远程过程调用，也就是说两台服务器 A，B，一个应用部署在 A 服务器上，想要调用 B 服务器上应用提供的函数/方法，由于不在一个内存空间，不能直接调用，需要通过网络来表达调用的语义和传达调用的数据。

### 隧道

隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。主要为了解决明文的`HTTP proxy`无法代理跑在`TLS`中的流量（`https`）的问题（也就是让`http`跑在`TLS`线路中），同时提供了作为任意流量的`TCP`通道的能力。Web 隧道允许用户通过`HTTP`连接发送非`HTTP`流量，这样就可以在`HTTP`上捎带其他协议数据了。使用 Web 隧道最常见的原因就是要在`HTTP`连接中嵌入非`HTTP`流量，从而让这类流量可以穿过只允许 Web 流量通过的防火墙。

需要隧道的原因是因为如果使用代理复用`HTTP proxy`来跑`HTTPS`流量，代理没网站的私钥证书，没办法与服务器建立连接，所以有了隧道这个应用程序，代理不再是中间人，而是直接原样传输。

Web 隧道是用`HTTP`的`CONNECT`方法建立起来的，隧道本身不会去解析`HTTP`请求，将请求保持原样中转给之后的服务器，且隧道会在通信双方断开连接时结束。而发送到代理的请求对代理来说是完全可见的，隧道则完全不可见。

对于`CONNECT`报文的请求，是没有`content`部分的，只有请求行和请求头。这两者仅供代理服务器使用，不能传给远端服务器。请求头部分一旦结束（连续的两组 CRLF），后面所有的数据都被代理直接转发，而且不限长度，直到从客户端的`TCP`通道关闭。 对于`CONNECT`报文的返回值，代理服务器在和远端服务器成功建立连接后，会向客户端返回任意一个`2xx`状态码，含义是和远端服务器建立连接成功，这个响应返回的报文头部分一旦结束（连续的两组 CRLF），后面所有的数据均为远端服务器返回的数据，同理代理会直接转发远端服务器的返回数据给客户端，直到从远端服务器的`TCP`通道关闭。

## 保存资源的缓存

> Web 缓存（或 HTTP 缓存）是用于临时存储（缓存）Web 文档（如 HTML 页面和图像），以减少服务器延迟的一种信息技术。 Web 缓存系统会保存下通过这套系统的文档的副本；如果满足某些条件，则可以由缓存满足后续请求。

缓存是指代理服务器或客户端本地磁盘内保存的资源副本。利用缓存可减少对源服务器的访问，因此也就节省了通信流量和通信时间。

缓存服务器是代理服务器的一种，并归类在缓存代理类型中。换句话说，当代理转发从服务器返回的响应时，代理服务器将会保存一份资源的副本。

使用缓存的好处：

- 缓存减少了冗余的数据传输，节省了你的网络费用

- 缓存缓解了网络瓶颈的问题。不需要更多的带宽就能够更快地加载页面

- 缓存降低了对原始服务器的要求。服务器可以更快地响应，避免过载的出现

- 缓存降低了距离时延，因为从较远的地方加载页面会更慢一些

### 缓存相关的字段

在`HTTP`官方文档中与缓存相关的首部字段如下：

![](3.png)

`Pragma`相当于`Catch-Control: no-catch`，它的属性值也只有一个，就是`no-catch`，表示禁用缓存。
当表示缓存过期时间时，优先级从高到低分别是`Pragma -> Cache-Control -> Expires`。

作为请求首部，`Cache-Control`的值可以为：

![](4.png)

作为响应首部，`Cache-Control`的值可以为：

![](5.png)

也可以自由组合，但是要注意逻辑，就比如`no-cache`就不能和`max-age`、`min-fresh`、`max-stale`一起使用。

### 缓存的局限性

为了保证缓存的可靠性要约定一个过期时间，假设使用`Expires`首部字段，每次客户端发起请求都会检查该字段时间是否过期，只有过期才会请求。

如果文件缓存规定时间过期了，但是其实文件没修改，这样的请求应该被避免，`Last-Modified`与`if-Modified-Since`两个字段就是避免这种情况，这两个字段的意思就是指明文件的最新修改时间。后者是请求头，前者是响应头。后者会取前者的值在请求报文头部中发送。如果没修改，服务器返回`304`，客户端直接使用缓存。

设定最新修改时间还是有局限性，首先过期时间这个字段的可靠性不是很高（浏览器就可以直接修改），其次在比较极端的情况下，最后修改时间只能精确到**秒**这个精度是不够的，所以有了`Etag`与`If-None-Match`，且由于`Expires`的不稳定，新增了`max-age`字段来替代它。`Etag`优先级也比`Last-Modified`高，客户端将带有`If-None-Match`请求发给服务器，服务器发现与自己的`Etag`对不上，就会返回最新的资源和字段。如果相同，还是会返回`304`。

以上三个方案都存在一些局限性，如果过期时间没到，后边那些字段就没用。这种情况仅靠`HTTP`就无法解决了。所以就有了`MD5/Hash`缓存和`CDN`缓存永不过期。

#### MD5/Hash 缓存

通过不缓存`HTML`，为静态文件添加`MD5`或者`Hash`标识，解决浏览器无法跳过过期时间主动感知文件变化的问题。为每一个静态文件的文件名都增加版本号（或`MD5`值），每次更新文件都同时更新版本号，每个文件都在`Cache-Control`设为永不过期， 同时`HTML`等入口文件的`Cache-Control`则设为禁止缓存，这样每次请求都是相同的路径，不同的文件，根本就不会去看缓存中有没有，只需要在项目每次发布迭代将修改过的静态文件添加不同的`MD5`或`Hash`标识就可以了。

> MD5 信息摘要算法（英语：MD5 Message-Digest Algorithm），一种被广泛使用的密码散列函数，可以产生出一个 128 位（16 字节）的散列值（Hash value），用于确保信息传输完整一致。

> Hash，一般翻译做散列、杂凑，或音译为哈希，是把任意长度的输入（又叫做预映射 pre-image）通过散列算法变换成固定长度的输出，该输出就是散列值。这种转换是一种压缩映射，也就是，散列值的空间通常远小于输入的空间，不同的输入可能会散列成相同的输出，所以不可能从散列值来确定唯一的输入值。简单的说就是一种将任意长度的消息压缩到某一固定长度的消息摘要的函数。

#### CDN 缓存

> CDN 是构建在网络之上的内容分发网络，依靠部署在各地的边缘服务器，通过中心平台的负载均衡、内容分发、调度等功能模块，使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。CDN 的关键技术主要有内容存储和分发技术。

`CDN`缓存：`CDN`将源站的数据缓存在全国高性能加速节点上，当浏览器请求，`CDN`将请求调度至最近的节点代替源站判断并处理此处请求。解决了跨区域和访问速度慢的问题。

具体工作流程是每次请求都被`CDN`拦截，按照过期时间决定资源是请求新的还是发送缓存。但是，`CDN`和客户端不同的地方在于它是可以手动更新缓存的，本来缓存的文件就是更新频率不高，这么一来也相当于变相解决了问题。

### 浏览器各种操作对缓存的影响

![](6.png)
